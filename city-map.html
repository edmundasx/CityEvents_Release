<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renginiai Vilniuje - CityEvents</title>
    

    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/city-map.css">
    <link rel="stylesheet" href="assets/css/navbar.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <a href="index.html" class="logo">CityEvents</a>
                <nav class="nav">
                    <!-- Renginiai (Events): Core functionality – scrolls to events section on same page -->
                    <a href="#events" class="nav-link" title="Renginiai – pagrindinė renginių peržiūra">
                        Renginiai
                    </a>

                    <!-- Žemėlapis (Map): Visual exploration – opens city map page -->
                    <a href="city-map.html" class="nav-link" title="Žemėlapis – vizualus renginių žemėlapis">
                        Žemėlapis
                    </a>

                    <!-- Organizatoriams (For Organizers): Attract event hosts -->
                    <a href="for-organizers.html" class="nav-link" title="Organizatoriams – informacija renginių organizatoriams">
                        Organizatoriams
                    </a>

                    <!-- Pagalba (Help): FAQ access -->
                    <a href="help-center.html" class="nav-link" title="Pagalba – DUK ir pagalbos centras">
                        Pagalba
                    </a>
                </nav>
            </div>
            <div class="header-right">
                <div class="header-actions" id="authActions">
                    <a class="btn btn-outline js-login-trigger" href="#login">Prisijungti</a>
                    <a class="btn btn-primary js-signup-trigger" href="#signup">Registruotis</a>
                </div>
            </div>
        </div>
    </header>

    <div class="breadcrumbs">
        <a href="index.html">Pradžia</a>
        <span>/</span>
        <a href="#">Lietuva</a>
        <span>/</span>
        <a href="#">Vilnius</a>
        <span>/</span>
        <span>Renginiai šį savaitgalį</span>
    </div>

    <div class="main-container">
        <div class="page-header">
            <h1>Renginiai šį savaitgalį Vilniuje</h1>
            <p>Atrask populiariausius renginius savo mieste arba rask ką nors naujo.</p>
        </div>

        <!-- Filters Sidebar -->
        <aside class="filters-sidebar" id="filtersSidebar">
            <h2 class="filters-title">Filtrai</h2>

            <div class="active-filters">
                <span style="font-size: 0.8125rem; color: var(--muted-foreground);">1 filtras taikomas</span>
                <div class="filter-tag">
                    Šį savaitgalį
                    <button onclick="removeFilter(this)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6 6 18M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <button class="clear-all" onclick="clearAllFilters()">Išvalyti viską</button>
            </div>

            <div class="filter-section">
                <h3>Kategorija</h3>
                <label class="filter-option">
                    <input type="checkbox" name="category" value="business">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 7h-9M14 17H5M17 17a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM7 7a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/>
                    </svg>
                    Verslas
                </label>
                <label class="filter-option">
                    <input type="checkbox" name="category" value="food">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8h1a4 4 0 0 1 0 8h-1M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8ZM6 1v3M10 1v3M14 1v3"/>
                    </svg>
                    Maistas ir gėrimai
                </label>
                <label class="filter-option">
                    <input type="checkbox" name="category" value="health">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
                    </svg>
                    Sveikata
                </label>
                <label class="filter-option">
                    <input type="checkbox" name="category" value="music">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18V5l12-2v13M9 18c0 1.66-1.34 3-3 3s-3-1.34-3-3 1.34-3 3-3 3 1.34 3 3ZM21 16c0 1.66-1.34 3-3 3s-3-1.34-3-3 1.34-3 3-3 3 1.34 3 3Z"/>
                    </svg>
                    Muzika
                </label>
                <label class="filter-option">
                    <input type="checkbox" name="category" value="art">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/>
                        <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.555C21.965 6.012 17.461 2 12 2Z"/>
                    </svg>
                    Menas
                </label>
                <button class="view-more">Rodyti daugiau</button>
            </div>

            <div class="filter-section">
                <h3>Data</h3>
                <label class="filter-option">
                    <input type="radio" name="date" value="today">
                    Šiandien
                </label>
                <label class="filter-option">
                    <input type="radio" name="date" value="tomorrow">
                    Rytoj
                </label>
                <label class="filter-option">
                    <input type="radio" name="date" value="weekend" checked>
                    Šį savaitgalį
                </label>
                <label class="filter-option">
                    <input type="radio" name="date" value="custom">
                    Pasirinkti datą...
                </label>
            </div>

            <div class="filter-section">
                <h3>Rajonas</h3>
                <label class="filter-option">
                    <input type="checkbox" name="neighborhood" value="senamiestis">
                    Senamiestis
                </label>
                <label class="filter-option">
                    <input type="checkbox" name="neighborhood" value="snipiskes">
                    Šnipiškės
                </label>
                <label class="filter-option">
                    <input type="checkbox" name="neighborhood" value="naujamiestis">
                    Naujamiestis
                </label>
                <label class="filter-option">
                    <input type="checkbox" name="neighborhood" value="uzupis">
                    Užupis
                </label>
            </div>

            <div class="filter-section">
                <h3>Kaina</h3>
                <label class="filter-option">
                    <input type="checkbox" name="price" value="free">
                    Nemokami
                </label>
                <label class="filter-option">
                    <input type="checkbox" name="price" value="paid">
                    Mokami
                </label>
            </div>
        </aside>

        <!-- Events List -->
        <main class="events-content">
            <button class="mobile-filter-toggle" onclick="toggleFilters()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
                </svg>
                Filtrai
            </button>

            <p class="events-count">Rasta <strong>12</strong> renginių</p>

            <div id="eventsList">
                <!-- Events will be populated by JS -->
            </div>
        </main>

        <!-- Map Section -->
        <aside class="map-section">
            <div class="map-container" id="mapContainer">
                <div class="map-placeholder">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                    <p>Vilniaus žemėlapis</p>
                </div>
                
                <!-- Sample markers -->
                <div class="map-marker" style="top: 30%; left: 45%;" title="Vasaros muzikos festivalis">
                    <span>1</span>
                </div>
                <div class="map-marker" style="top: 45%; left: 55%;" title="Maisto turgus">
                    <span>2</span>
                </div>
                <div class="map-marker" style="top: 60%; left: 40%;" title="Meno paroda">
                    <span>3</span>
                </div>
                <div class="map-marker" style="top: 35%; left: 65%;" title="Tech konferencija">
                    <span>4</span>
                </div>
                <div class="map-marker" style="top: 55%; left: 30%;" title="Jogas parke">
                    <span>5</span>
                </div>

                <button class="map-toggle">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/>
                        <line x1="9" x2="9" y1="3" y2="18"/>
                        <line x1="15" x2="15" y1="6" y2="21"/>
                    </svg>
                    Žemėlapis
                </button>
            </div>
        </aside>
    </div>

    <script src="assets/js/api.js"></script>
    <script src="assets/js/app.js"></script>
    <script>
        let mapEvents = [];
        let allEvents = [];

        const filtersSidebar = document.getElementById('filtersSidebar');
        const filterInputs = filtersSidebar.querySelectorAll('.filter-option input');
        const activeFiltersEl = filtersSidebar.querySelector('.active-filters');

        const neighborhoodKeywords = {
            senamiestis: ['senamiestis', 'old town'],
            snipiskes: ['šnipiškės', 'snipiskes'],
            naujamiestis: ['naujamiestis'],
            uzupis: ['užupis', 'uzupis'],
        };

        function formatEventDate(eventDate) {
            const date = new Date(eventDate);
            return date.toLocaleString('lt-LT', {
                month: 'long',
                day: 'numeric',
                weekday: 'long',
                hour: '2-digit',
                minute: '2-digit',
            });
        }

        function formatPrice(price) {
            if (!price || Number(price) === 0) {
                return 'Nemokamas';
            }
            return Number(price).toFixed(2) + '€';
        }

        function renderEventsList() {
            const eventsList = document.getElementById('eventsList');
            const eventsCount = document.querySelector('.events-count strong');

            if (!mapEvents.length) {
                eventsList.innerHTML = '<div class="loading">Šiuo metu renginių nėra.</div>';
                eventsCount.textContent = '0';
                return;
            }

            eventsCount.textContent = mapEvents.length;

            eventsList.innerHTML = mapEvents.map(event => {
                const isFavorite = state.favorites.includes(event.id);
                return `
                    <article class="event-card" data-event-id="${event.id}">
                        <img src="${event.cover_image || 'https://images.unsplash.com/photo-1459749411175-04bf5292ceea?w=400&h=300&fit=crop'}" alt="${event.title}" class="event-image">
                        <div class="event-details">
                            <span class="event-date">${formatEventDate(event.event_date)}</span>
                            <h3 class="event-title">${event.title}</h3>
                            <p class="event-location">${event.location}</p>
                            <div class="event-meta">
                                <span class="event-price">${formatPrice(event.price)}</span>
                                <span class="event-category">${event.category || 'Renginys'}</span>
                            </div>
                        </div>
                        <div class="event-actions">
                            <button class="like-btn ${isFavorite ? 'active' : ''}" data-favorite="${event.id}" aria-pressed="${isFavorite}">
                                <svg viewBox="0 0 24 24" fill="${isFavorite ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                                    <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
                                </svg>
                            </button>
                        </div>
                    </article>
                `;
            }).join('');

            eventsList.querySelectorAll('[data-favorite]').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await toggleFavorite(btn.dataset.favorite);
                    renderEventsList();
                });
            });

            eventsList.querySelectorAll('.event-card').forEach(card => {
                card.addEventListener('click', () => viewEvent(card.dataset.eventId));
            });
        }

        function viewEvent(id) {
            window.location.href = `event-details.html?id=${id}`;
        }

        function toggleFilters() {
            document.getElementById('filtersSidebar').classList.toggle('active');
        }

        function getSelectedFilters() {
            const selectedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked')).map(i => i.value);
            const selectedNeighborhoods = Array.from(document.querySelectorAll('input[name="neighborhood"]:checked')).map(i => i.value);
            const selectedPrices = Array.from(document.querySelectorAll('input[name="price"]:checked')).map(i => i.value);
            const selectedDate = document.querySelector('input[name="date"]:checked');

            return {
                categories: selectedCategories,
                neighborhoods: selectedNeighborhoods,
                prices: selectedPrices,
                date: selectedDate ? selectedDate.value : '',
            };
        }

        function endOfDay(date) {
            const end = new Date(date);
            end.setHours(23, 59, 59, 999);
            return end;
        }

        function getDateRange(dateFilter) {
            if (!dateFilter) return null;

            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            switch (dateFilter) {
                case 'today':
                    return { start, end: endOfDay(start) };
                case 'tomorrow': {
                    const tomorrow = new Date(start);
                    tomorrow.setDate(start.getDate() + 1);
                    return { start: tomorrow, end: endOfDay(tomorrow) };
                }
                case 'weekend': {
                    const day = now.getDay();
                    const daysUntilSaturday = (6 - day + 7) % 7;
                    const saturday = new Date(start);
                    saturday.setDate(start.getDate() + daysUntilSaturday);
                    const sunday = new Date(saturday);
                    sunday.setDate(saturday.getDate() + 1);
                    return { start: saturday, end: endOfDay(sunday) };
                }
                default:
                    return null;
            }
        }

        function matchesNeighborhood(event, selectedNeighborhoods) {
            if (!selectedNeighborhoods.length) return true;
            if (!event.location) return false;

            const location = event.location.toLowerCase();
            return selectedNeighborhoods.some(area => {
                const keywords = neighborhoodKeywords[area] || [area];
                return keywords.some(keyword => location.includes(keyword));
            });
        }

        function matchesPrice(event, selectedPrices) {
            if (!selectedPrices.length) return true;

            return selectedPrices.some(price => {
                if (price === 'free') return !event.price || Number(event.price) === 0;
                if (price === 'paid') return event.price && Number(event.price) > 0;
                return true;
            });
        }

        function matchesDate(event, dateFilter) {
            if (!dateFilter) return true;

            const range = getDateRange(dateFilter);
            if (!range) return true;

            const eventDate = new Date(event.event_date);
            return eventDate >= range.start && eventDate <= range.end;
        }

        function filterEvents() {
            const selected = getSelectedFilters();

            mapEvents = allEvents.filter(event => {
                const categoryMatch = !selected.categories.length || selected.categories.includes(event.category);
                const neighborhoodMatch = matchesNeighborhood(event, selected.neighborhoods);
                const priceMatch = matchesPrice(event, selected.prices);
                const dateMatch = matchesDate(event, selected.date);

                return categoryMatch && neighborhoodMatch && priceMatch && dateMatch;
            });

            renderEventsList();
            renderActiveFilters(selected);
        }

        function getFilterLabel(input) {
            const label = input.closest('label');
            return label ? label.textContent.trim() : input.value;
        }

        function createFilterTag(label, type, value) {
            const tag = document.createElement('div');
            tag.className = 'filter-tag';
            tag.textContent = label;

            const button = document.createElement('button');
            button.addEventListener('click', () => removeFilter(type, value));
            button.innerHTML = `
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6 6 18M6 6l12 12"/>
                </svg>
            `;

            tag.appendChild(button);
            return tag;
        }

        function renderActiveFilters(selected) {
            if (!activeFiltersEl) return;

            activeFiltersEl.innerHTML = '';

            const selectedCount = selected.categories.length + selected.neighborhoods.length + selected.prices.length + (selected.date ? 1 : 0);
            const summary = document.createElement('span');
            summary.style.fontSize = '0.8125rem';
            summary.style.color = 'var(--muted-foreground)';
            summary.textContent = selectedCount ? `${selectedCount} filtras${selectedCount > 1 ? 'i' : ''} taikoma` : 'Filtrai netaikomi';
            activeFiltersEl.appendChild(summary);

            if (!selectedCount) return;

            if (selected.date) {
                const input = document.querySelector(`input[name="date"][value="${selected.date}"]`);
                activeFiltersEl.appendChild(createFilterTag(getFilterLabel(input), 'date', selected.date));
            }

            selected.categories.forEach(value => {
                const input = document.querySelector(`input[name="category"][value="${value}"]`);
                activeFiltersEl.appendChild(createFilterTag(getFilterLabel(input), 'category', value));
            });

            selected.neighborhoods.forEach(value => {
                const input = document.querySelector(`input[name="neighborhood"][value="${value}"]`);
                activeFiltersEl.appendChild(createFilterTag(getFilterLabel(input), 'neighborhood', value));
            });

            selected.prices.forEach(value => {
                const input = document.querySelector(`input[name="price"][value="${value}"]`);
                activeFiltersEl.appendChild(createFilterTag(getFilterLabel(input), 'price', value));
            });

            const clearBtn = document.createElement('button');
            clearBtn.className = 'clear-all';
            clearBtn.textContent = 'Išvalyti viską';
            clearBtn.addEventListener('click', clearAllFilters);
            activeFiltersEl.appendChild(clearBtn);
        }

        function removeFilter(type, value) {
            const input = document.querySelector(`input[name="${type}"][value="${value}"]`);
            if (input) {
                input.checked = false;
                filterEvents();
            }
        }

        function clearAllFilters() {
            filterInputs.forEach(input => {
                input.checked = false;
            });

            filterEvents();
        }

        function attachFilterListeners() {
            filterInputs.forEach(input => {
                input.addEventListener('change', filterEvents);
            });
        }

        async function loadCityMapEvents() {
            try {
                const [events] = await Promise.all([
                    ensureEventsLoaded({ include_all: 1 }),
                    fetchUserFavorites(),
                ]);

                allEvents = events && events.length ? events : getKnownEvents();
            } catch (error) {
                console.error('Nepavyko užkrauti renginių:', error);
                allEvents = getKnownEvents();
            }

            filterEvents();
        }

        attachFilterListeners();
        loadCityMapEvents();
    </script>
</body>
</html>
