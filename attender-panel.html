<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mano Paskyra - CityEvents</title>
    

    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/attender-panel.css">
    <link rel="stylesheet" href="assets/css/navbar.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <a href="index.html" class="logo">CityEvents</a>
                <nav class="nav">
                    <!-- Renginiai (Events): Core functionality â€“ scrolls to events section on same page -->
                    <a href="#events" class="nav-link" title="Renginiai â€“ pagrindinÄ— renginiÅ³ perÅ¾iÅ«ra">
                        Renginiai
                    </a>

                    <!-- Å½emÄ—lapis (Map): Visual exploration â€“ opens city map page -->
                    <a href="city-map.html" class="nav-link" title="Å½emÄ—lapis â€“ vizualus renginiÅ³ Å¾emÄ—lapis">
                        Å½emÄ—lapis
                    </a>

                    <!-- Organizatoriams (For Organizers): Attract event hosts -->
                    <a href="for-organizers.html" class="nav-link" title="Organizatoriams â€“ informacija renginiÅ³ organizatoriams">
                        Organizatoriams
                    </a>

                    <!-- Pagalba (Help): FAQ access -->
                    <a href="help-center.html" class="nav-link" title="Pagalba â€“ DUK ir pagalbos centras">
                        Pagalba
                    </a>
                </nav>
            </div>
            <div class="header-right">
                <div class="header-actions" id="authActions">
                    <a class="btn btn-outline js-login-trigger" href="#login">Prisijungti</a>
                    <a class="btn btn-primary js-signup-trigger" href="#signup">Registruotis</a>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="page-header">
            <div class="page-header-text">
                <h1>Sveiki, <span id="userName">Vartotojas</span>! ğŸ‘‹</h1>
                <p>Valdykite savo pamÄ—gtus renginius ir perÅ¾iÅ«rÄ—kite rekomendacijas</p>
            </div>
            <button class="btn btn-accent" onclick="openProfileModal()">âœï¸ Redaguoti mano profilÄ¯</button>
        </div>

        <div class="dashboard-grid">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Favorites Section -->
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">â¤ï¸ PamÄ—gti renginiai</h2>
                        <span class="section-badge" id="favoritesCount">0 renginiai</span>
                    </div>
                    <div class="event-list" id="favoritesList">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Recommendations Section -->
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">â­ Rekomenduojami renginiai</h2>
                        <a href="/" class="btn btn-outline" style="padding: 0.35rem 1rem; font-size: 0.85rem;">Å½iÅ«rÄ—ti visus</a>
                    </div>
                    <div class="recommendation-grid" id="recommendationsList">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                <!-- Calendar Section -->
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">ğŸ“… RenginiÅ³ kalendorius</h2>
                    </div>
                    <div class="calendar-header-nav">
                        <button class="calendar-nav-btn" onclick="prevMonth()">â—€</button>
                        <span class="calendar-month" id="calendarMonth">Gruodis 2024</span>
                        <button class="calendar-nav-btn" onclick="nextMonth()">â–¶</button>
                    </div>
                    <div class="calendar-grid" id="calendarDayHeaders">
                        <div class="calendar-day-header">Pr</div>
                        <div class="calendar-day-header">An</div>
                        <div class="calendar-day-header">Tr</div>
                        <div class="calendar-day-header">Kt</div>
                        <div class="calendar-day-header">Pn</div>
                        <div class="calendar-day-header">Å t</div>
                        <div class="calendar-day-header">Sk</div>
                    </div>
                    <div class="calendar-grid" id="calendarDays">
                        <!-- Populated by JS -->
                    </div>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid hsl(var(--border));">
                        <p style="font-size: 0.85rem; color: hsl(var(--muted-foreground)); margin-bottom: 0.5rem;">Artimiausi renginiai:</p>
                        <div id="upcomingEventsList" style="font-size: 0.9rem;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Redaguoti profilÄ¯</h2>
                <button class="modal-close" onclick="closeProfileModal()">âœ•</button>
            </div>
            <form id="profileForm" onsubmit="saveProfile(event)">
                <div class="modal-body">
                    <div class="avatar-section">
                        <div class="avatar" id="modalAvatar">VU</div>
                        <div class="avatar-info">
                            <h3 id="modalUserName">Vartotojas</h3>
                            <p id="modalUserType">Lankytojas</p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ‘¤ Vardas ir PavardÄ—</label>
                        <input type="text" class="form-input" id="inputName" placeholder="Ä®veskite vardÄ…" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“§ El. paÅ¡tas</label>
                        <input type="email" class="form-input" id="inputEmail" placeholder="Ä®veskite el. paÅ¡tÄ…" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“± Telefonas</label>
                        <input type="tel" class="form-input" id="inputPhone" placeholder="+370 600 00000">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“ Miestas</label>
                        <input type="text" class="form-input" id="inputCity" placeholder="Vilnius">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeProfileModal()">AtÅ¡aukti</button>
                    <button type="submit" class="btn btn-primary">ğŸ’¾ IÅ¡saugoti</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Success Toast -->
    <div class="toast" id="successToast">
        âœ… Profilis sÄ—kmingai atnaujintas!
    </div>

    <script src="assets/js/api.js"></script>
    <script src="assets/js/app.js"></script>
    <script>
        const attenderState = {
            user: null,
            favorites: [],
            favoriteIds: new Set(),
            events: [],
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
        };
        const fallbackImage = 'https://via.placeholder.com/400x250?text=CityEvents';

        document.addEventListener('DOMContentLoaded', () => {
            enforceSession();
            loadPanelData();
        });

        function enforceSession() {
            const user = getStoredUser();
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            attenderState.user = user;
            document.getElementById('userName').textContent = user.name?.split(' ')[0] || 'Vartotojas';
            document.body.dataset.page = 'user-panel';
            renderAuthActions();
        }

        async function loadPanelData() {
            if (!attenderState.user) return;

            setLoadingState();

            try {
                const [eventsResult, favoritesResult] = await Promise.all([
                    window.apiService.getEvents(),
                    window.apiService.getFavorites(attenderState.user.id),
                ]);

                const events = eventsResult?.data?.length ? eventsResult.data : getKnownEvents();
                attenderState.events = events || [];

                attenderState.favorites = favoritesResult?.data || [];
                attenderState.favoriteIds = new Set(attenderState.favorites.map(f => Number(f.event_id ?? f.id)));

                renderFavorites();
                renderRecommendations();
                renderCalendar();
                renderUpcomingEvents();
            } catch (error) {
                console.error('Nepavyko uÅ¾krauti duomenÅ³', error);
                showErrorState('Nepavyko uÅ¾krauti duomenÅ³. Bandykite dar kartÄ….');
            }
        }

        function setLoadingState() {
            const favoritesList = document.getElementById('favoritesList');
            const recommendationsList = document.getElementById('recommendationsList');

            favoritesList.innerHTML = '<div class="loading">Ä®keliama...</div>';
            recommendationsList.innerHTML = '<div class="loading">Ä®keliama...</div>';
        }

        function showErrorState(message) {
            const favoritesList = document.getElementById('favoritesList');
            const recommendationsList = document.getElementById('recommendationsList');

            favoritesList.innerHTML = `<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><h3>${message}</h3></div>`;
            recommendationsList.innerHTML = '<div class="empty-state"><p>RekomendacijÅ³ nepavyko uÅ¾krauti.</p></div>';
        }

        function renderFavorites() {
            const container = document.getElementById('favoritesList');
            document.getElementById('favoritesCount').textContent = `${attenderState.favorites.length} renginiai`;

            if (!attenderState.favorites.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ’”</div>
                        <h3>NÄ—ra pamÄ—gtÅ³ renginiÅ³</h3>
                        <p>PradÄ—kite narÅ¡yti ir paÅ¾ymÄ—kite patinkanÄius renginius!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = attenderState.favorites.map(event => `
                <div class="event-card" onclick="viewEvent(${event.id})">
                    <img src="${event.cover_image || event.image || fallbackImage}" alt="${event.title}" class="event-card-image">
                    <div class="event-card-content">
                        <span class="event-card-category">${event.category || 'Renginys'}</span>
                        <h3 class="event-card-title">${event.title}</h3>
                        <div class="event-card-info">
                            <span>ğŸ“… ${formatEventDate(event.event_date)}</span>
                            <span>ğŸ“ ${event.location || 'Vieta neapibrÄ—Å¾ta'}</span>
                        </div>
                    </div>
                    <div class="event-card-actions">
                        <button class="btn-icon favorite-toggle active" onclick="toggleFavorite(event, ${event.id})" title="PaÅ¡alinti iÅ¡ pamÄ—gtÅ³">â¤ï¸</button>
                    </div>
                </div>
            `).join('');
        }

        function renderRecommendations() {
            const container = document.getElementById('recommendationsList');
            const upcoming = (attenderState.events || []).filter(event => {
                if (!event.event_date) return false;
                const eventDate = new Date(event.event_date);
                return eventDate >= new Date();
            });

            const recommendations = upcoming
                .filter(event => !attenderState.favoriteIds.has(Number(event.id)))
                .slice(0, 6);

            if (!recommendations.length) {
                container.innerHTML = '<div class="empty-state"><p>NÄ—ra rekomendacijÅ³. PamÄ—ginkite narÅ¡yti renginius.</p></div>';
                return;
            }

            container.innerHTML = recommendations.map(event => `
                <div class="recommendation-card">
                    <img src="${event.cover_image || event.image || fallbackImage}" alt="${event.title}" class="recommendation-image" onclick="viewEvent(${event.id})">
                    <div class="recommendation-body">
                        <span class="recommendation-tag">${event.category || 'Renginys'}</span>
                        <h3 class="recommendation-title" onclick="viewEvent(${event.id})">${event.title}</h3>
                        <div class="recommendation-info" onclick="viewEvent(${event.id})">
                            <span>ğŸ“… ${formatEventDate(event.event_date)}</span> â€¢ <span>ğŸ“ ${event.location || 'NeÅ¾inoma vieta'}</span>
                        </div>
                    </div>
                    <div class="recommendation-actions">
                        <button class="btn-icon favorite-toggle ${attenderState.favoriteIds.has(Number(event.id)) ? 'active' : ''}" onclick="toggleFavorite(event, ${event.id})" aria-label="PamÄ—gti renginÄ¯">â¤ï¸</button>
                    </div>
                </div>
            `).join('');
        }

        function renderCalendar() {
            const container = document.getElementById('calendarDays');
            const monthNames = ['Sausis', 'Vasaris', 'Kovas', 'Balandis', 'GeguÅ¾Ä—', 'BirÅ¾elis',
                               'Liepa', 'RugpjÅ«tis', 'RugsÄ—jis', 'Spalis', 'Lapkritis', 'Gruodis'];

            document.getElementById('calendarMonth').textContent = `${monthNames[attenderState.currentMonth]} ${attenderState.currentYear}`;

            const firstDay = new Date(attenderState.currentYear, attenderState.currentMonth, 1).getDay();
            const daysInMonth = new Date(attenderState.currentYear, attenderState.currentMonth + 1, 0).getDate();
            const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;

            const today = new Date();
            const isCurrentMonth = today.getMonth() === attenderState.currentMonth && today.getFullYear() === attenderState.currentYear;

            const eventDates = getEventDatesForMonth(attenderState.currentMonth, attenderState.currentYear);

            let html = '';

            const prevMonthDays = new Date(attenderState.currentYear, attenderState.currentMonth, 0).getDate();
            for (let i = adjustedFirstDay - 1; i >= 0; i--) {
                html += `<div class="calendar-day other-month">${prevMonthDays - i}</div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = isCurrentMonth && day === today.getDate();
                const hasEvent = eventDates.includes(day);
                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (hasEvent) classes += ' has-event';
                html += `<div class="${classes}">${day}</div>`;
            }

            const totalCells = adjustedFirstDay + daysInMonth;
            const remaining = 42 - totalCells;
            for (let i = 1; i <= remaining && totalCells + i <= 42; i++) {
                html += `<div class="calendar-day other-month">${i}</div>`;
            }

            container.innerHTML = html;
        }

        function getEventDatesForMonth(month, year) {
            return attenderState.events
                .filter(event => {
                    if (!event.event_date) return false;
                    const date = new Date(event.event_date);
                    return date.getMonth() === month && date.getFullYear() === year;
                })
                .map(event => new Date(event.event_date).getDate());
        }

        function renderUpcomingEvents() {
            const container = document.getElementById('upcomingEventsList');
            const now = new Date();
            const upcoming = attenderState.favorites
                .filter(event => event.event_date && new Date(event.event_date) >= now)
                .sort((a, b) => new Date(a.event_date) - new Date(b.event_date))
                .slice(0, 5);

            if (!upcoming.length) {
                container.innerHTML = '<p style="color: hsl(var(--muted-foreground));">NÄ—ra artimÅ³ renginiÅ³</p>';
                return;
            }

            container.innerHTML = upcoming.map(event => `
                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0; border-bottom: 1px solid hsl(var(--border) / 0.5);">
                    <span style="color: hsl(var(--accent));">â€¢</span>
                    <span style="flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${event.title}</span>
                    <span style="color: hsl(var(--muted-foreground)); font-size: 0.8rem;">${formatEventDate(event.event_date)}</span>
                </div>
            `).join('');
        }

        function formatEventDate(dateString) {
            if (!dateString) return 'Data nepateikta';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Data nepateikta';
            return date.toLocaleDateString('lt-LT', {
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
            });
        }

        async function toggleFavorite(e, eventId) {
            e.stopPropagation();

            if (!attenderState.user) {
                window.location.href = 'index.html';
                return;
            }

            try {
                const response = await window.apiService.toggleFavorite({
                    event_id: eventId,
                    user_id: attenderState.user.id,
                });

                if (response.removed) {
                    attenderState.favorites = attenderState.favorites.filter(f => Number(f.event_id ?? f.id) !== Number(eventId));
                } else if (response.favorite) {
                    attenderState.favorites.unshift(response.favorite);
                }

                attenderState.favoriteIds = new Set(attenderState.favorites.map(f => Number(f.event_id ?? f.id)));
                renderFavorites();
                renderRecommendations();
                renderCalendar();
                renderUpcomingEvents();
            } catch (error) {
                console.error('Nepavyko atnaujinti pamÄ—gtÅ³', error);
                alert('Nepavyko atnaujinti pamÄ—gtÅ³ renginiÅ³.');
            }
        }

        function prevMonth() {
            attenderState.currentMonth--;
            if (attenderState.currentMonth < 0) {
                attenderState.currentMonth = 11;
                attenderState.currentYear--;
            }
            renderCalendar();
        }

        function nextMonth() {
            attenderState.currentMonth++;
            if (attenderState.currentMonth > 11) {
                attenderState.currentMonth = 0;
                attenderState.currentYear++;
            }
            renderCalendar();
        }

        function viewEvent(eventId) {
            window.location.href = `/event-details.html?id=${eventId}`;
        }

        // Profile Modal
        function openProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.classList.add('active');

            const userData = attenderState.user || {};
            document.getElementById('inputName').value = userData.name || '';
            document.getElementById('inputEmail').value = userData.email || '';
            document.getElementById('inputPhone').value = userData.phone || '';
            document.getElementById('inputCity').value = userData.city || userData.location || '';

            const initials = (userData.name || 'VU').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            document.getElementById('modalAvatar').textContent = initials;
            document.getElementById('modalUserName').textContent = userData.name || 'Vartotojas';
            document.getElementById('modalUserType').textContent = userData.role === 'organizer' ? 'Organizatorius' : 'Lankytojas';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('active');
        }

        function saveProfile(e) {
            e.preventDefault();

            const updatedUser = {
                ...attenderState.user,
                name: document.getElementById('inputName').value,
                email: document.getElementById('inputEmail').value,
                phone: document.getElementById('inputPhone').value,
                city: document.getElementById('inputCity').value,
            };

            saveUser(updatedUser);
            attenderState.user = updatedUser;
            document.getElementById('userName').textContent = updatedUser.name?.split(' ')[0] || 'Vartotojas';
            closeProfileModal();

            const toast = document.getElementById('successToast');
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 3000);
        }

        document.getElementById('profileModal').addEventListener('click', (e) => {
            if (e.target.id === 'profileModal') {
                closeProfileModal();
            }
        });
    </script>
</body>
</html>
